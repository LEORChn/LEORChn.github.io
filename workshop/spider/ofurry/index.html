<body></body>
<script src="/js/base.js"></script>
<script src="/js/3/md5.2.18.0.min.js"></script>
<script src="/js/3/jszip.3.3.0.min.js"></script>
<script>
var ofur_api = atob('aHR0cHM6Ly9hcGkub2Z1cnJ5LmNvbQ==');
var z = new JSZip();
var crew_log = [],
	roles_log = [];
var laststatus = '',
	lastroleids = [],
	lastroles = {},
	lastroles_textmd5 = '';

function onHelperMain(){
	setTimeout(daemon_proxy, 5000);
	setInterval(daemon_proxy, 120000);
	function daemon_proxy(){
		daemon();
	}
}
function daemon(){
	claw();
	backup();
	show_usage();
	show_leaks();
}
//show_leaks();
function show_leaks(){
	var root = hbody.initChildren('div#usage', 'table#leaks');
	if(!root.children.length) root.appendChildren(
		ct('tr').appendChildren(
			ct('th', 'id'),
			ct('th', 'name'),
			ct('th', 'avatar'),
			ct('th', 'imgs')
		)
	).setAttr('rules', 'all');
	pl(root.$$('tr+tr'));
	root.$$('tr+tr').foreach(function(e){ // 先标记所有为已删除，稍后再给仍存活的角色清除标记
		e.setAttr('deleted','');
	});
	Object.keys(lastroles).foreach(function(e){
		var c = lastroles[e].content,
			row = root.initChildren('tr.role_' + e),
			td_id =     row.initChildren('td.id'),
			td_name =   row.initChildren('td.name'),
			td_avatar = row.initChildren('td.avatar'),
			td_imgs =   row.initChildren('td.imgs');
		if(lastroleids.contains(parseInt(e))) row.removeAttribute('deleted'); // 只是为了确保这个确实还活着（在最后一次读取列表时）
		td_id.innerText = e;
		td_name.innerText = c.roleName;
		var containedAvatar = td_avatar.$$('img[origin-src]').map(function(e){
			return e.getAttribute('origin-src');
		}), containedImgs   = td_imgs.$$('img[origin-src]').map(function(e){
			return e.getAttribute('origin-src');
		});
		if(!containedAvatar.contains(c.roleAvatar)) td_avatar.appendChild(
			ct('img').setAttr('origin-src', c.roleAvatar)
		);
		c.roleImages.foreach(function(e){
			if(containedImgs.contains(e)) return;
			td_imgs.appendChild(
				ct('img').setAttr('origin-src', e)
			);
		});
		
	});
}
/*
function fetch_next_img(){
	var oj = $('[origin-src]:not([src])');
	if(oj.getAttribute('origin-src').contains('ofur.cc/')){
		oj.src = '/';
		return fetch_next_img();
	}
	http('get ' + oj.getAttribute('origin-src'), 'referer: https://ofurry.com/', ArrayBuffer, function(){
		oj.src = new Blob([this.response]).toURL();
		fetch_next_img();
	});
}
function exportImages(){
	return JSON.stringify($$('[origin-src][src]').map(function(e, i){
		return {
			url: e.src,
			name: i + '_' + e.parentNode.parentNode.className + '_' + e.parentNode.className,
			note: e.getAttribute('origin-src')
		}
	}));
}
function containToZip(obj){
	obj.foreach(function(e){
		impl(e.url, e.name, e.note);
	});
	function impl(bloburl, name, note){
		http('get ' + bloburl, ArrayBuffer, function(){
			z.file(name, this.response, {
				comment: note
			});
		});
	}
}
function exportZip(){
	z.generateAsync({
		type: "blob",
	    compression: "DEFLATE",
	    compressionOptions: {
	        level: 9
	    }
	}, function(meta){
		pl(`压缩进度：${Math.floor(meta.percent)}%`);
	}).then(function(e){
		window.zipfile = e;
	});
}
*/
function show_usage(){
	var root = hbody.initChildren('div#usage', 'table#localstorage').clearChildren().appendChildren(
		ct('tr').appendChildren(
			ct('th', 'localStorage'),
			ct('th', '大小')
		)
	).setAttr('rules', 'all');
	var totalCalc = 0;
	new Array(localStorage.length).fill(0).map(function(e, i){
		return localStorage.key(i);
	}).filter(function(e){
		return e.startsWith('ofur_');
	}).foreach(function(e){
		totalCalc += localStorage[e].length;
		root.appendChildren(
			ct('tr').appendChildren(
				ct('td', e),
				ct('td', localStorage[e].length.toFileSize())
			)
		);
	});
	root.appendChildren(
		ct('tr').appendChildren(
			ct('td', '本应用总计'),
			ct('td', totalCalc.toFileSize())
		),
		ct('tr').appendChildren(
			ct('td', '所有应用总计'),
			ct('td', localStorage.size.toFileSize())
		)
	);
}
var starttime = Date.now();
function backup(){
	localStorage['ofur_crew_' + starttime] = JSON.stringify(crew_log);
	localStorage['ofur_roles_' + starttime] = JSON.stringify(roles_log);
}
function claw(){
	getRoleInfo(0, null, function(){
		if(laststatus != this.responseText){
			laststatus = this.responseText;
			crew_log.push({
				ts: Date.now(),
				text: laststatus
			});
			console.info(laststatus.length, [laststatus]);
		}
		claw_roles();
	});
}
var roles_outofdate = Date.now();
function claw_roles(){
	if(Date.now() < roles_outofdate) return;
	roles_outofdate = Date.now() + 3600000;
	var roles = JSON.parse(laststatus).content;
	if(type(roles) != 'Array') return;
	lastroleids = roles.map(function(e){
		return e.roleId;
	});
	lastroleids.foreach(function(e){
		getRoleInfo(1, e, function(){
			try{
				lastroles[e] = this.responseText;
				lastroles[e] = JSON.parse(this.responseText);
			}catch(e){}
		});//https://api.ofurry.com/getRoleInfo?type=1&roleId=1000017&_=16552
	});
	setTimeout(function(){
		var tmp = md5(JSON.stringify(lastroles));
		if(lastroles_textmd5 == tmp) return;
		lastroles_textmd5 = tmp;
		roles_log.push(lastroles);
	}, 20000);
}
function getRoleInfo(type, roleId, func){
	http(`get ${ofur_api}/getRoleInfo?type=${type}${roleId? '&roleId=' + roleId: ''}&_=${Date.now()}`, func);
}
function renderImages1(){
	var view = $('#imgs') || ct('div#imgs');
	
	
	view.clearChildren().appendChildren(
		imgs.map(function(e){
			return ct('div').appendChildren(
				e.map(function(e){
					return ct('img').setAttr('src', e).setAttr('href', e);
				})
			)
		})
	);
	document.body.appendChildren(view);
}
//renderImages()
function crew_export(){
	hbody.appendChild(JSON.stringify(crew_log).toBlob().toDownload());
}
function export_all_changes(){
	var roles = {};
	crew_log.foreach(function(e){
		var j = JSON.parse(e.text);
		if(!j.content) return;
		j.content.foreach(function(f){
			// 如果角色ID不存在，则为其新建一个空间
			if(!(f.roleId in roles)) roles[f.roleId] = {
				avatar: {}
			};
			var r = roles[f.roleId];
			// 如果没有记录头像，或最后一个头像不等于当前头像，则对头像进行一次记录
			var lastkey = null;
			for(var k in r.avatar) lastkey = k;
			if((!lastkey) || (r.avatar[k] != f.roleAvatar)){
				r.avatar[e.ts] = f.roleAvatar; // 执行一次记录。键名为 crew_log[].ts
			}
		});
	});
	return roles;
}
</script>
<script>
/*
*/
</script>
<style>
#localstorage td:nth-child(2){
	text-align: right;
}
table img{
	max-height: 50px;
}
tr[deleted]{
  background: rgba(255,0,0,.1)
}
</style>
