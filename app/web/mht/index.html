<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no"/>
		<title>MHT 工具 - 瑞兽谷</title>
		<script>
			var ui = {
				title: '标题栏',
				head: {
					title: '页面内标题栏',
					//theme: '#0099ff',
					isTextBright: true,
					/*drop: [
						{
							name: '',
							data: 'javascript:_chat.onShowMembers();'
						}
					]*/
				},
				side: [
					/*{
						name: '返回博物馆大厅',
						data: '/#archive/'
					},
					{
						name: '返回全部应用',
						data: '/#artwork/'
					},*/
					{
						name: '返回瑞兽谷首页',
						data: '/'
					},
					{
						_blank: [true],
						name: '致谢',
						data: [
							'MUI-CSS', 'https://www.muicss.com/',
							'Materialize-CSS', 'https://materializecss.com/',
							'BootCDN', 'https://www.bootcdn.cn/'
						]
					}
				],
				content: {
					fitsSystemWindows: true,
					root: null,
					window: null,
					window_name: 'mht-window'
				}
			};
		</script>
<style>
/* @import "mht.css"; */
body{
	background:#cfc
}
.help:not(:hover)>pre{
	display:none
}
.help>pre{
	position: absolute;
	line-height: 1.3em;
	font-family: "monospace";
	background: #efe;
	tab-size: 4;
	-moz-tab-size: 4;
	margin-top: 0;
	border: solid 1px;
	padding-right: 2em;
}
table tr:last-child{
	text-align:center
}
table td, table th{
	padding:5px 10px
}
table td:not(:first-child){
	text-align:right
}
table a{
	text-decoration:none
}
</style>
	</head>
	<body>
		<span class="help">
			<input type="button" value="如何使用？">
			<pre> 
	--- 使用方法 ---
	1.打开电脑QQ并登录
	2.进入“消息管理器”，选择一个分组或者特定联系人导出消息记录
		或者在右上角三角菜单选择“导出全部消息记录”
	3.选择保存文件类型，默认为 bak 格式，切换为 mht 格式
	4.消息导出时间较长，请耐心等待。
	
	5.在本工具页面点击“选择文件”，选择刚才保存的 MHT 文件
	6.压缩优化的过程耗时可能较长，请耐心等待。
	
	7.下载优化版文件。
			</pre>
		</span>
		<span class="help">
			<input type="button" value="注意事项">
			<pre> 
	--- 法律相关注意 ---
	　　如果你使用 MHT 格式存储聊天记录，由于此格式比较容易被篡改，
	所以QQ不支持将其中的内容重新导入到自身数据库，在需要法律证据时
	这种格式可能也不具有法律效力。
	　　如需备份一份可重新导入且有法律效力的格式，请使用默认的
	bak 加密数据库格式。
	　　另请注意，加密数据库格式不包含图片、视频、语音和其他互相传输的文件，
	因此在完成 bak 格式备份后，你还要额外备份其他多媒体文件以确保数据完整。
	
	毕竟我不能保证你天时地利人和，这使我无法相信你一定能得到腾讯的帮助。
	
	--- 优化版相比原版的优点 ---
	1.体积更小，测试用文件原 400 KB，压缩后为 85 KB，仅需 21% 空间。
	2.加载得更快，因为 DOM 节点元素更少了。
	3.操作更灵活，能够收起指定某天的全部记录。
	
	--- 优化版的缺陷 ---
	本工具为早期版本，功能尚未完善，还可能因为未完全覆盖测试而出现各种错误。
	由于压缩后的网页文件使用伪元素显示重复内容，
	但很多浏览器不支持选择、复制和搜索伪元素文本，比如 Chrome 43；
	Firefox 83 可以搜索伪元素文本，但是不能复制；
	IE 11 能够复制伪元素文本，但是不能从伪元素中间开始选择文本。
	但是可以通过“打印”选项保存为 PDF 格式，然后在 PDF 阅读器里搜索或复制。
			</pre>
		</span>
		<span class="help">
			<input type="button" value="鸽王待办">
			<pre> 
	--- 计划中的后续更新内容 ---
	1.支持打包图片、去除冗余
	2.支持分析消息内容，比如有多少QQ不支持导出类型的消息、系统消息条目数
	3.将处理代码分离到 worker，这样可以
		1.显示进度条
		2.避免堵塞主线程、导致界面假死的状况
			</pre>
		</span>
		<span class="help">
			<input type="button" value="更新日志">
			<pre> 
	v1.0.2  -  2020-12-9
	【修复/兼容】新版QQ导出消息不显示帐号的情况。
	以上反馈感谢：Doweny Rem
	【优化体验】导出后页面的展开/折叠按钮热点区域
	【优化体验】导出后页面的全部展开/折叠按钮保持在右上角
	以上两项优化将导致文件大小增加 158 Byte ( 0.15 KiB ) 望周知
	
	v1.0.1  -  2020-7-7
	【修复】当导出的聊天记录是12小时制时无法转换的问题。
	以上反馈感谢：kaimo
	
	v1.0.0  -  2020-6-17
	基础功能。
			</pre>
		</span>
		<br><br>
		现在开始 →
		<input type="file" onchange="main()" accept="application/*, application/octet-stream, application/x-mimearchive, .mht, .mhtml">
		<!-- leorchn base lib -->
		<script src="/js/baseLib.js"></script>
		<script src="/js/http.js"></script>
		<script src="/js/date.js"></script>
		<script src="/js/TextStream.js"></script>
		<script>
			var DEBUG_JS = location.hostname == '127.0.0.1'? '?'+new Date().getTime(): '';
			addJs('tencent-message-manager.js' + DEBUG_JS);
			var processor = null,
				dl = null;
			function main(){
				var file = $('[type=file]').files[0] || f[0];
				var savename = file.name;
				// TencentChatData(f[0])  is same to  TencentChatData.decrypt(f[0])
				
				UI_table_init();
				
				UI_table_update('读取 MHT 文件', file.size);
				
				processor = TencentChatData.decrypt(file).then(function(e){
					var stoptime = new Date();
					UI_table_update('解压聊天记录主页面', new Blob([e.parsedObject.html]).size, stoptime);
					return new Promise(function(success){
						success(e.compress());
					});
				}).then(function(e){
					var stoptime = new Date();
					var blob = new Blob([e], {type:'text/plain;charset=utf-8'});
					UI_table_update('压缩页面', blob.size, stoptime);
					var tr = ct('tr'),
						td = ct('td'),
						a = ct('a', '点击下载');
					a.href = URL.createObjectURL(blob);
					a.setAttribute('download', savename + '.html');
					td.setAttribute('colspan', dl.rows[0].children.length);
					td.appendChild(a);
					tr.appendChild(td);
					dl.appendChild(tr);
				}).catch(function(e){
					var tr = ct('tr'),
						td = ct('td', '抱歉，出错了！\n' + savename + '\n' + e.stack);
					td.setAttribute('colspan', dl.rows[0].children.length);
					td.style.textAlign = 'left';
					tr.appendChild(td);
					dl.appendChild(tr);
				});
			}
			
			
			function UI_table_init(){
				if(dl) dl.remove();
				dl = ct('table');
				dl.setAttribute('rules', 'all');
				var tr = ct('tr');
				'执行操作,开始时间,耗时(秒),数据大小'.split(',').foreach(function(e){
					tr.appendChild(ct('th', e));
				});
				dl.appendChild(tr);
				htmlbody.appendChild(dl);
			}
			
			function UI_table_update(name, size, stoptime){
					var tr = ct('tr');
					var timecost = 0;
					var datecurrent = stoptime || new Date();
					var timecurrent = datecurrent.getTime();
					if(dl.rows.length > 1) timecost = timecurrent - parseInt(dl.rows[dl.rows.length -1].getAttribute('starttime'));
					var sizedelta = [0, 'KiB', 'MiB', 'GiB'];
					while(size > 1024){
						size = (size / 1024).toFixed(3);
						sizedelta[0]++;
					}
					if(timecost > 0) timecost = (timecost / 1000).toFixed(3);
					tr.appendChildren(ct('td', name), ct('td', datecurrent.format('yyyy-MM-dd hh:mm:ss')), ct('td', timecost), ct('td', size + (sizedelta[0]>0? ' '+sizedelta[sizedelta[0]]:'')));
					tr.setAttribute('starttime', timecurrent);
					dl.appendChild(tr);
				};
		</script>
	</body>
</html>
